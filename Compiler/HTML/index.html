<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Funky3!!!</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.5.0/ace.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.5.1/theme-solarized_dark.min.js" defer></script>
        <link rel="stylesheet" href="style.css">
        <script>
            window.addEventListener("load", ev => {
                console.log("Loaded!");
                window.editor = ace.edit("code");
                {
                    editor.setOptions({
                        useWrapMode: true,
                        highlightActiveLine: true,
                        showPrintMargin: false,
                        theme: 'ace/theme/solarized_dark',
                        mode: 'ace/mode/javascript'
                    });

                    editor.on('change', function(){
                        // MAYBE change the save url.
                        var code = editor.getValue();
                        var params = new URLSearchParams(window.location.search);
                        if(code.length < 512){
                            // If we've loaded a file, don't change the URL.
                            if(!params.has('file')){
                                params.set('code', code);
                                window.history.replaceState(null, null, '?' + params.toString());
                            }
                        }else if(params.has('file')){ // Pop the query, so they know they need to save.
                            window.history.replaceState(null, null, '?');
                        }
                    });
                }

                {
                    var params = new URLSearchParams(window.location.search);
                    if(params.has('code')){
                        window.editor.setValue(params.get('code'));
                    }else{
                        let xhr = new XMLHttpRequest();
                        xhr.open("GET", "/currentCode.txt", true);
                        xhr.setRequestHeader("Content-Type", "application/json");
                        xhr.addEventListener("load", ev => {
                            console.log("Loaded code!");
                            window.editor.setValue(xhr.responseText);
                        });
                        xhr.send();
                    }
                }
                window.worker = null;
                window.worker = new Worker("/funky3.js");
                worker.addEventListener("message", ev => {
                    document.getElementById("output").innerHTML += ev.data;
                });
                document.getElementById("run").addEventListener("click", ev => {
                    let code = editor.getValue();
                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", "/postCode", true);
                    xhr.setRequestHeader("Content-Type", "application/json");
                    xhr.addEventListener("load", ev => {
                        // Reload the iframe.
                        document.getElementById("preCompiled").src += "";
                        document.getElementById("compiled").src += "";
                        document.getElementById("error").src += "";
                        //document.getElementById("output").src += "";
                        if(worker!=null){
                            worker.terminate();
                            worker = null;
                        }
                        document.getElementById("output").innerHTML = "";
                        window.worker = new Worker("/funky3.js");

                        worker.addEventListener("message", ev => {
                            document.getElementById("output").innerHTML += ev.data;
                        });
                    });
                    xhr.send(code);
                });

                document.getElementById("save").addEventListener("click", ev => {
                    let code = editor.getValue();
                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", "/save", true);
                    xhr.setRequestHeader("Content-Type", "application/json");
                    xhr.addEventListener("load", ev => {
                        if(xhr.status == 200) {
                            console.log("Saved!");
                            document.location = `/index.html${xhr.responseText}`;
                        }else{
                            console.log(`Error saving! ${xhr.status}`);
                            console.log(xhr.responseText);
                        }
                    });
                    xhr.send(code);
                });

                var buttons = $(".tabButton");
                var tabBodies = $(".tabBody");
                for (var i=0; i < buttons.length; i++){
                    let buttonID = i;
                    buttons[i].addEventListener("click", ev => {
                        // Disable all buttons and tabs
                        for (var j=0; j < buttons.length; j++){
                            if(j == buttonID){
                                buttons[j].classList.add("active");
                                tabBodies[j].classList.add("active");
                            }else{
                                buttons[j].classList.remove("active");
                                tabBodies[j].classList.remove("active");
                            }
                        }
                    });
                }

                var examples = $(".example");
                for (var i=0; i < examples.length; i++){
                    let exampleID = examples[i].getAttribute("file");
                    examples[i].addEventListener("click", ev => {
                        let xhr = new XMLHttpRequest();
                        xhr.open("GET", "/getExample?file=" + exampleID, true);
                        xhr.addEventListener("load", ev => {
                            window.location = "/index.html";
                        });
                        xhr.send();
                    });
                }
            });
        </script>
    </head>
    <body>
        <textarea id="code"></textarea> 
        <div id="tabHolder">
            <div id="tabButtons">
                <button id="run"><span class="icon">‚ñ∂Ô∏è</span><span class="text">Run</span></button>
                <button id="tabOutputButton" class="tabButton active"><span class="icon">üßæ</span><span class="text">Output</span></button>
                <button id="tabPreCompiledButton" class="tabButton"><span class="icon">üì•</span><span class="text">Pre-Compiled</span></button>
                <button id="tabCompiledButton" class="tabButton"><span class="icon">üì§</span><span class="text">Compiled</span></button>
                <button id="tabErrorButton" class="tabButton"><span class="icon">‚ö†Ô∏è</span><span class="text">Error</span></button>
                <button id="tabSaveLoadButton" class="tabButton"><span class="icon">üíæ</span><span class="text">Save / Examples</span></button>
            </div>
            <div id="tabBodies">
                <div id="tabOutput" class="tabBody active">
                    <pre id="output"></pre>
                </div>
                <div id="tabPreCompiled" class="tabBody">
                    <iframe id="preCompiled" src="precompiled.html" width="50%" height="100%"></iframe>
                </div>
                <div id="tabCompiled" class="tabBody">
                    <iframe id="compiled" src="compiled.html" width="50%" height="100%"></iframe>
                </div>
                <div id="tabError" class="tabBody">
                    <iframe id="error" src="error.html" width="50%" height="100%"></iframe>
                </div>
                <div id="tabSaveLoad" class="tabBody">
                    <p>Saving will store a copy of your code for sharing with others. There is no garuntee regarding the privacy of code saved.</p>
                    <button id="save">Save</button>
                    <hr>
                    <h2>Examples</h2>
                    <p>These examples help demonstrate how Funky 3 handles.<br>Clicking any of these buttons <b>WILL</b> make you lose your progress. Save first is you really don't want to lose it.</p>
                    <button class="example" file="helloworld.fnk">Hello, World!</button>
                    <button class="example" file="loops.fnk">Loops</button>
                    <button class="example" file="strings.fnk">Strings</button>
                    <button class="example" file="math.fnk">Math</button>
                    <button class="example" file="deoperator.fnk">De-Operator</button>
                    <button class="example" file="functions.fnk">Functions</button>
                    <button class="example" file="lists.fnk">Lists</button>
                </div>
            </div>
        </div>
    </body>
</html>
